{% extends "plugin_base.html" %}

{% block extra_head %}
<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
{% endblock %}

{% block extra_styles %}
/* Music plugin specific styling */
.music-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.75rem;
}

/* Hide music controls when no server selected */
.music-controls-hidden {
    opacity: 0.3;
    pointer-events: none;
    user-select: none;
}

.no-server-message {
    text-align: center;
    padding: 3rem 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--card-radius);
    margin-bottom: 2rem;
}

.no-server-message h3 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1.25rem;
}

.no-server-message p {
    color: var(--text-secondary);
    margin-bottom: 0;
}

.music-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--card-radius);
    padding: 1.6rem 1.8rem;
    box-shadow: var(--shadow-sm);
}

.music-section h3 {
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.connection-details {
    margin: 0 0 1.2rem 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* Modern Music Player Styling */
.current-track {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
    border: 1px solid rgba(226, 232, 240, 0.8);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow:
        0 10px 25px rgba(0, 0, 0, 0.1),
        0 4px 10px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

[data-theme="dark"] .current-track {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
    border: 1px solid rgba(71, 85, 105, 0.5);
    box-shadow:
        0 10px 25px rgba(0, 0, 0, 0.3),
        0 4px 10px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.current-track::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
    opacity: 0.8;
}

.track-info {
    margin-bottom: 1.5rem;
    text-align: center;
}

.track-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    line-height: 1.3;
    letter-spacing: -0.025em;
}

.track-author {
    color: var(--text-secondary);
    font-size: 1rem;
    font-weight: 500;
    opacity: 0.8;
}

.progress-container {
    margin: 1.5rem 0;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    overflow: hidden;
    margin: 0.75rem 0;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
}

.progress-bar:hover {
    height: 10px;
    margin: 0.65rem 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    width: 0%;
    transition: width 0.1s ease;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
}

.progress-time {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
}

/* Modern Control Buttons */
.controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: center;
    margin: 2rem 0 1.5rem 0;
}

.control-btn {
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    color: #374151;
    border: 1px solid rgba(209, 213, 219, 0.8);
    padding: 0;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: 600;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
        0 4px 6px rgba(0, 0, 0, 0.05),
        0 1px 3px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    position: relative;
    overflow: hidden;
    min-width: unset;
}

[data-theme="dark"] .control-btn {
    background: linear-gradient(145deg, #374151, #4b5563);
    color: #f9fafb;
    border: 1px solid rgba(75, 85, 99, 0.8);
    box-shadow:
        0 4px 6px rgba(0, 0, 0, 0.2),
        0 1px 3px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

/* Primary play/pause button - only when active */
.control-btn.primary-active {
    background: linear-gradient(145deg, #6366f1, #8b5cf6);
    color: white;
    width: 56px;
    height: 56px;
    font-size: 1.4rem;
    border: none;
    box-shadow:
        0 8px 25px rgba(99, 102, 241, 0.3),
        0 4px 12px rgba(99, 102, 241, 0.2);
}

.control-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow:
        0 8px 25px rgba(0, 0, 0, 0.1),
        0 4px 12px rgba(0, 0, 0, 0.08);
}

[data-theme="dark"] .control-btn:hover {
    box-shadow:
        0 8px 25px rgba(0, 0, 0, 0.3),
        0 4px 12px rgba(0, 0, 0, 0.2);
}

.control-btn.primary-active:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow:
        0 12px 35px rgba(99, 102, 241, 0.4),
        0 6px 16px rgba(99, 102, 241, 0.3);
}

.control-btn:active {
    transform: translateY(0) scale(0.98);
    transition: all 0.1s ease;
}

.control-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

/* Control button icons */
.control-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    opacity: 0.1;
    border-radius: 50%;
    background: currentColor;
    transition: all 0.3s ease;
}

.control-btn:hover::before {
    width: 40px;
    height: 40px;
    opacity: 0.1;
}

/* Modern Volume Control */
.volume-control {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1.5rem 0;
    padding: 1rem;
    background: rgba(248, 250, 252, 0.5);
    border-radius: 16px;
    border: 1px solid rgba(226, 232, 240, 0.6);
}

[data-theme="dark"] .volume-control {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(71, 85, 105, 0.4);
}

.volume-control span {
    font-size: 1.1rem;
    opacity: 0.7;
    min-width: fit-content;
}

.volume-slider {
    flex: 1;
    height: 6px;
    border-radius: 8px;
    background: rgba(148, 163, 184, 0.3);
    outline: none;
    cursor: pointer;
    appearance: none;
    position: relative;
    transition: all 0.2s ease;
}

.volume-slider:hover {
    height: 8px;
}

.volume-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(145deg, #6366f1, #8b5cf6);
    cursor: pointer;
    box-shadow:
        0 4px 12px rgba(99, 102, 241, 0.3),
        0 2px 6px rgba(99, 102, 241, 0.2);
    transition: all 0.2s ease;
    border: 2px solid white;
}

.volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow:
        0 6px 20px rgba(99, 102, 241, 0.4),
        0 3px 10px rgba(99, 102, 241, 0.3);
}

.volume-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(145deg, #6366f1, #8b5cf6);
    cursor: pointer;
    border: 2px solid white;
    box-shadow:
        0 4px 12px rgba(99, 102, 241, 0.3),
        0 2px 6px rgba(99, 102, 241, 0.2);
    transition: all 0.2s ease;
}

.volume-slider::-moz-range-thumb:hover {
    transform: scale(1.1);
}

#volume-display {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    min-width: 40px;
    text-align: center;
    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
}

.add-track {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.add-track form {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.add-track input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid var(--input-border);
    border-radius: 8px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.95rem;
}

.add-track .btn {
    padding: 0.75rem 1.25rem;
    white-space: nowrap;
}

.add-track input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px var(--focus-ring);
}

.btn[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
    box-shadow: none;
}

.queue-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-primary);
}

.queue-list-offline .queue-item {
    opacity: 0.75;
}

.queue-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    transition: background 0.2s ease;
}

.queue-item:hover {
    background: rgba(148, 163, 184, 0.1);
}

.queue-item:last-child {
    border-bottom: none;
}

.queue-item-info {
    flex: 1;
    min-width: 0;
}

.queue-item-title {
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.queue-item-author {
    font-size: 0.85rem;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.queue-item-duration {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-family: monospace;
}

.btn-remove {
    background: var(--danger-color);
    color: white;
    border: none;
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
}

.btn-remove:hover {
    background: #dc2626;
    transform: scale(1.05);
}

/* Modern Mode Controls */
.mode-controls {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin: 1.5rem 0 1rem 0;
}

.mode-btn {
    background: linear-gradient(145deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.8));
    color: var(--text-secondary);
    border: 1px solid rgba(203, 213, 225, 0.6);
    padding: 0.6rem 1rem;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    position: relative;
    overflow: hidden;
}

[data-theme="dark"] .mode-btn {
    background: linear-gradient(145deg, rgba(51, 65, 85, 0.8), rgba(71, 85, 105, 0.8));
    border: 1px solid rgba(100, 116, 139, 0.4);
    box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.mode-btn.active {
    background: linear-gradient(145deg, #6366f1, #8b5cf6);
    color: white;
    border-color: transparent;
    box-shadow:
        0 4px 12px rgba(99, 102, 241, 0.3),
        0 2px 6px rgba(99, 102, 241, 0.2);
    transform: translateY(-1px);
}

.mode-btn:hover {
    transform: translateY(-1px);
    box-shadow:
        0 6px 20px rgba(0, 0, 0, 0.1),
        0 3px 10px rgba(0, 0, 0, 0.05);
    border-color: rgba(99, 102, 241, 0.4);
}

[data-theme="dark"] .mode-btn:hover {
    box-shadow:
        0 6px 20px rgba(0, 0, 0, 0.3),
        0 3px 10px rgba(0, 0, 0, 0.2);
}

.mode-btn.active:hover {
    box-shadow:
        0 8px 25px rgba(99, 102, 241, 0.4),
        0 4px 12px rgba(99, 102, 241, 0.3);
}

.mode-btn:active {
    transform: translateY(0);
    transition: all 0.1s ease;
}

/* Mode button icons - Font Awesome */
.mode-btn i {
    font-size: 1rem;
    opacity: 0.8;
    margin-right: 0.5rem;
}

.mode-btn.active i {
    opacity: 1;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 1rem;
}

.status-connected {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.status-disconnected {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger-color);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.empty-queue {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.queue-offline-hint {
    margin-top: 1rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-align: center;
}

.queue-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 0.75rem;
    margin: 1.25rem 0 0.5rem 0;
}

.queue-stat-card {
    background: rgba(148, 163, 184, 0.08);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 10px;
    padding: 0.75rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.queue-stat-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
}

.queue-stat-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
}

.queue-meta-footer {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

@media (max-width: 1024px) {
    .music-grid {
        grid-template-columns: 1fr;
    }
}

[data-theme="dark"] .no-server-message {
    background: rgba(15, 23, 42, 0.9);
    border-color: rgba(148, 163, 184, 0.3);
}

@media (max-width: 768px) {
    .controls {
        gap: 0.5rem;
    }

    .control-btn {
        padding: 0.5rem 0.75rem;
        min-width: 70px;
        font-size: 0.8rem;
    }

    .mode-controls {
        flex-wrap: wrap;
    }
}
{% endblock %}

{% block content %}
<!-- No server selected message -->
<div id="no-server-message" class="no-server-message">
    <h3><i class="fas fa-music"></i> Select a Server</h3>
    <p>Please select a server from the sidebar to start managing music playback.</p>
</div>

<!-- Music controls (hidden by default) -->
<div id="music-controls" class="music-grid music-controls-hidden">
    <!-- Left Column: Player Controls -->
    <div class="music-section">
        <h3><i class="fas fa-play-circle"></i> Player Controls</h3>

        <div id="connection-status" class="status-indicator status-disconnected">
            <i class="fas fa-circle" style="color: #dc2626;"></i> Disconnected
        </div>

        <p id="connection-details" class="connection-details">
            Connect the bot to a voice channel to enable playback controls.
        </p>

        <div id="current-track" class="current-track" style="display: none;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                <i class="fas fa-music" style="font-size: 1.1rem; color: var(--accent-color);"></i>
                <span style="font-weight: 600; color: var(--text-primary);">Now Playing</span>
            </div>

            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                <div id="track-artwork" style="width: 80px; height: 80px; border-radius: 12px; overflow: hidden; flex-shrink: 0; background: linear-gradient(145deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-music" style="font-size: 2rem; color: var(--accent-color); opacity: 0.6;"></i>
                </div>
                <div class="track-info" style="flex: 1; margin-bottom: 0;">
                    <div class="track-title" id="track-title">No track playing</div>
                    <div class="track-author" id="track-author"></div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-time">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button type="button" id="play-pause-btn" class="control-btn" disabled
                    hx-post="/api/music/controls/play"
                    hx-include="[name='guild_id']"
                    hx-target="#control-result">
                <i class="fas fa-play"></i>
            </button>
            <button type="button" id="skip-btn" class="control-btn" disabled
                    hx-post="/api/music/controls/skip"
                    hx-include="[name='guild_id']"
                    hx-target="#control-result">
                <i class="fas fa-step-forward"></i>
            </button>
            <button type="button" id="stop-btn" class="control-btn" disabled
                    hx-post="/api/music/controls/stop"
                    hx-include="[name='guild_id']"
                    hx-target="#control-result">
                <i class="fas fa-stop"></i>
            </button>
        </div>

        <div class="volume-control">
            <i class="fas fa-volume-up"></i>
            <input type="range" id="volume-slider" class="volume-slider"
                   min="0" max="150" value="50" disabled>
            <span id="volume-display">50%</span>
        </div>

        <div class="mode-controls">
            <button type="button" id="repeat-off" class="mode-btn active"
                    hx-post="/api/music/repeat"
                    hx-vals='{"mode": "off"}'
                    hx-include="[name='guild_id']"
                    hx-target="#control-result">
                <i class="fas fa-redo"></i> Off
            </button>
            <button type="button" id="repeat-track" class="mode-btn"
                    hx-post="/api/music/repeat"
                    hx-vals='{"mode": "track"}'
                    hx-include="[name='guild_id']"
                    hx-target="#control-result">
                <i class="fas fa-redo-alt"></i> Track
            </button>
            <button type="button" id="repeat-queue" class="mode-btn"
                    hx-post="/api/music/repeat"
                    hx-vals='{"mode": "queue"}'
                    hx-include="[name='guild_id']"
                    hx-target="#control-result">
                <i class="fas fa-redo"></i> Queue
            </button>
            <button type="button" id="shuffle-btn" class="mode-btn"
                    hx-post="/api/music/shuffle"
                    hx-include="[name='guild_id']"
                    hx-target="#control-result">
                <i class="fas fa-random"></i> Shuffle
            </button>
        </div>

        <div id="control-result" class="result"></div>
    </div>

    <!-- Right Column: Queue Management -->
    <div class="music-section">
        <h3><i class="fas fa-list"></i> Queue Management</h3>

        <div class="add-track">
            <form hx-post="/api/music/play" hx-target="#add-result">
                <input type="hidden" name="guild_id" value="" id="guild-id-input">
                <input type="text" name="query" id="add-track-input" placeholder="Enter song name, artist, or YouTube URL..." required>
                <button type="submit" class="btn" id="add-track-button"><i class="fas fa-plus"></i> Add to Queue</button>
            </form>
        </div>

        <div id="add-result" class="result"></div>

        <div class="queue-stats">
            <div class="queue-stat-card">
                <span class="queue-stat-label">Tracks</span>
                <span class="queue-stat-value" id="queue-count">0</span>
            </div>
            <div class="queue-stat-card">
                <span class="queue-stat-label">Total Length</span>
                <span class="queue-stat-value" id="queue-duration">0:00</span>
            </div>
            <div class="queue-stat-card">
                <span class="queue-stat-label">Repeat</span>
                <span class="queue-stat-value" id="queue-repeat">Off</span>
            </div>
            <div class="queue-stat-card">
                <span class="queue-stat-label">Shuffle</span>
                <span class="queue-stat-value" id="queue-shuffle">Off</span>
            </div>
        </div>

        <div class="queue-meta-footer" id="queue-last-updated">Last updated — waiting…</div>

        <div id="queue-container">
            <div class="empty-queue">
                <p>Queue is empty</p>
                <p class="text-sm">Add some tracks to get started!</p>
            </div>
        </div>

        <div id="queue-result" class="result"></div>
    </div>
</div>

<!-- Hidden input for guild ID -->
<input type="hidden" name="guild_id" value="" id="guild-id-hidden">
{% endblock %}

{% block extra_scripts %}
<script>
let currentGuildId = null;
let latestStatus = null;
let musicWebSocket = null;
let progressUpdateInterval = null;
let reconnectTimeout = null;

const QUEUE_LOADING_HTML = '<div class="empty-queue"><p>Loading queue...</p></div>';
const QUEUE_SELECT_SERVER_HTML = '<div class="empty-queue"><p>Select a server to view the queue.</p></div>';

document.body.addEventListener('guild-changed', (event) => {
    const guildId = event.detail.guildId;
    const noServerMessage = document.getElementById('no-server-message');
    const musicControls = document.getElementById('music-controls');

    if (guildId) {
        noServerMessage.style.display = 'none';
        musicControls.style.display = 'grid';
        musicControls.classList.remove('music-controls-hidden');
        handleMusicGuildChange(guildId);
    } else {
        noServerMessage.style.display = 'block';
        musicControls.style.display = 'none';
        musicControls.classList.add('music-controls-hidden');
        handleMusicGuildChange('');
    }
});

function formatTime(ms) {
    const totalMs = Number(ms ?? 0);
    const minutes = Math.floor(totalMs / 60000);
    const seconds = Math.floor((totalMs % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function extractYouTubeVideoId(url) {
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

function connectWebSocket(guildId) {
    if (musicWebSocket) {
        musicWebSocket.close();
    }

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/music/${guildId}`;

    musicWebSocket = new WebSocket(wsUrl);

    musicWebSocket.onopen = function(event) {
        console.log('Music WebSocket connected');
        setQueueFooter('Last updated — connected');
    };

    musicWebSocket.onmessage = function(event) {
        try {
            const message = JSON.parse(event.data);
            if (message.type === 'status_update' || message.type.endsWith('_update') || message.type.startsWith('track_') || message.type === 'queue_end') {
                latestStatus = message.data;
                updateUIFromStatus(message.data);
                refreshQueue();
            }
        } catch (error) {
            console.error('Error parsing WebSocket message:', error);
        }
    };

    musicWebSocket.onclose = function(event) {
        console.log('Music WebSocket disconnected');
        setQueueFooter('Last updated — disconnected');

        // Attempt to reconnect after 3 seconds if we still have a guild ID
        if (currentGuildId) {
            reconnectTimeout = setTimeout(() => {
                console.log('Attempting to reconnect WebSocket...');
                connectWebSocket(currentGuildId);
            }, 3000);
        }
    };

    musicWebSocket.onerror = function(error) {
        console.error('Music WebSocket error:', error);
    };

    // Send periodic ping to keep connection alive
    setInterval(() => {
        if (musicWebSocket && musicWebSocket.readyState === WebSocket.OPEN) {
            musicWebSocket.send(JSON.stringify({ type: 'ping' }));
        }
    }, 30000);
}

function updateUIFromStatus(status) {
    if (!status) return;

    const connectionStatus = document.getElementById('connection-status');
    const connectionDetails = document.getElementById('connection-details');
    if (status.connected) {
        connectionStatus.className = 'status-indicator status-connected';
        connectionStatus.innerHTML = '<i class="fas fa-circle" style="color: #10b981;"></i> Connected';
        connectionDetails.textContent = status.playing ? 'Playback in progress.' : 'Ready to play music.';
    } else {
        connectionStatus.className = 'status-indicator status-disconnected';
        connectionStatus.innerHTML = '<i class="fas fa-circle" style="color: #dc2626;"></i> Disconnected';
        connectionDetails.textContent = 'Connect the bot to a voice channel to enable playback controls.';
    }

    ['play-pause-btn', 'skip-btn', 'stop-btn'].forEach((id) => {
        const button = document.getElementById(id);
        if (button) {
            button.disabled = !status.connected;
        }
    });

    const volumeSlider = document.getElementById('volume-slider');
    volumeSlider.disabled = !status.connected;

    const addTrackInput = document.getElementById('add-track-input');
    const addTrackButton = document.getElementById('add-track-button');
    addTrackInput.disabled = !status.connected;
    addTrackButton.disabled = !status.connected;

    const currentTrackDiv = document.getElementById('current-track');
    const playPauseBtn = document.getElementById('play-pause-btn');

    if (status.current_track) {
        currentTrackDiv.style.display = 'block';
        document.getElementById('track-title').textContent = status.current_track.title;
        document.getElementById('track-author').textContent = status.current_track.author;
        document.getElementById('current-time').textContent = formatTime(status.current_track.position);
        document.getElementById('total-time').textContent = formatTime(status.current_track.duration);

        const progress = status.current_track.duration
            ? Math.min(100, (status.current_track.position / status.current_track.duration) * 100)
            : 0;
        document.getElementById('progress-fill').style.width = `${progress}%`;

        // Update track artwork - try to extract from YouTube URL or use default
        const trackArtwork = document.getElementById('track-artwork');
        if (status.current_track.uri && status.current_track.uri.includes('youtube')) {
            const videoId = extractYouTubeVideoId(status.current_track.uri);
            if (videoId) {
                trackArtwork.innerHTML = `<img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover;" alt="Track artwork">`;
            } else {
                trackArtwork.innerHTML = '<i class="fas fa-music" style="font-size: 2rem; color: var(--accent-color); opacity: 0.6;"></i>';
            }
        } else {
            trackArtwork.innerHTML = '<i class="fas fa-music" style="font-size: 2rem; color: var(--accent-color); opacity: 0.6;"></i>';
        }
    } else {
        currentTrackDiv.style.display = 'none';
        document.getElementById('progress-fill').style.width = '0%';
    }

    // Update play/pause button
    if (playPauseBtn) {
        playPauseBtn.classList.remove('primary-active');

        // Check if music is actively playing (not paused)
        const isActivelyPlaying = status.playing && !status.paused;

        // Debug logging
        console.log('Play/Pause Button Update:', {
            playing: status.playing,
            paused: status.paused,
            isActivelyPlaying: isActivelyPlaying,
            current_track: !!status.current_track
        });

        if (isActivelyPlaying) {
            // Music is actively playing - show pause button in purple
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.classList.add('primary-active');
            playPauseBtn.setAttribute('hx-post', '/api/music/controls/pause');
        } else if (status.current_track) {
            // Music exists but is paused/stopped - show play button in purple
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.classList.add('primary-active');
            playPauseBtn.setAttribute('hx-post', '/api/music/controls/play');
        } else {
            // No music loaded - show play button in gray
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('hx-post', '/api/music/controls/play');
        }

        // Ensure HTMX attributes are set properly
        playPauseBtn.setAttribute('hx-include', '[name="guild_id"]');
        playPauseBtn.setAttribute('hx-target', '#control-result');

        // Re-process this element with HTMX to update the event handlers
        if (window.htmx) {
            window.htmx.process(playPauseBtn);
        }
    }

    volumeSlider.value = status.volume;
    document.getElementById('volume-display').textContent = `${status.volume}%`;

    document.querySelectorAll('.mode-btn').forEach((btn) => btn.classList.remove('active'));
    const repeatButton = document.getElementById(`repeat-${status.repeat_mode}`);
    if (repeatButton) {
        repeatButton.classList.add('active');
    }
    const shuffleButton = document.getElementById('shuffle-btn');
    shuffleButton.classList.toggle('active', Boolean(status.shuffle_enabled));

    updateQueueStats(status);

    // Start/stop progress updates based on playback state
    if (status.playing && !status.paused && status.current_track) {
        startProgressUpdates();
    } else {
        stopProgressUpdates();
    }
}

async function refreshQueue(showLoading = false) {
    if (!currentGuildId) return;

    const queueContainer = document.getElementById('queue-container');
    if (!queueContainer) return;

    if (showLoading) {
        queueContainer.innerHTML = QUEUE_LOADING_HTML;
        setQueueFooter('Last updated — syncing…');
    }

    const status = latestStatus;
    if (!status) {
        return;
    }

    if (!status.connected) {
        queueContainer.innerHTML = renderOfflineQueue(status);
        updateQueueTimestamp();
        return;
    }

    const html = renderConnectedQueue(status);
    queueContainer.innerHTML = html;
    if (window.htmx) {
        htmx.process(queueContainer);
    }
    updateQueueTimestamp();
}

document.getElementById('volume-slider').addEventListener('input', function(e) {
    const volume = e.target.value;
    document.getElementById('volume-display').textContent = `${volume}%`;

    clearTimeout(this.volumeTimeout);
    this.volumeTimeout = setTimeout(() => {
        if (currentGuildId) {
            const formData = new FormData();
            formData.append('guild_id', currentGuildId);
            formData.append('volume', volume);

            fetch('/api/music/volume', {
                method: 'POST',
                body: formData
            });
        }
    }, 300);
});

function updateQueueStats(status) {
    document.getElementById('queue-count').textContent = status.queue.length;
    document.getElementById('queue-duration').textContent = formatTime(status.queue_duration);

    const repeatLabel = { off: 'Off', track: 'Track', queue: 'Queue' }[status.repeat_mode] || 'Off';
    document.getElementById('queue-repeat').textContent = repeatLabel;
    document.getElementById('queue-shuffle').textContent = status.shuffle_enabled ? 'On' : 'Off';
}

function escapeHtml(value) {
    if (typeof value !== 'string') {
        return String(value ?? '');
    }
    return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function renderConnectedQueue(status) {
    const queue = Array.isArray(status.queue) ? status.queue : [];

    if (queue.length === 0) {
        return '<div class="empty-queue"><p>Queue is empty</p><p class="text-sm">Add some tracks to get started!</p></div>';
    }

    const rawGuildId = String(currentGuildId ?? '');
    const guildId = rawGuildId.replace(/[^0-9]/g, '') || rawGuildId;
    let html = '<div class="queue-list">';
    queue.forEach((track, index) => {
        const title = escapeHtml(track.title ?? track.track_title ?? `Track ${index + 1}`);
        const author = escapeHtml(track.author ?? track.track_author ?? 'Unknown artist');
        const duration = formatTime(track.duration ?? track.track_duration ?? 0);
        const position = index;
        const hxVals = `{"guild_id": "${guildId}", "position": ${position}}`;

        html += `
            <div class="queue-item" data-position="${position}">
                <div class="queue-item-info">
                    <div class="queue-item-title">${title}</div>
                    <div class="queue-item-author">${author}</div>
                </div>
                <div class="queue-item-duration">${duration}</div>
                <button type="button"
                        class="btn-remove"
                        hx-post="/api/music/queue/remove"
                        hx-vals='${hxVals}'
                        hx-target="#queue-result">
                    🗑️
                </button>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

function renderOfflineQueue(status) {
    if (!status || !status.queue || status.queue.length === 0) {
        return '<div class="empty-queue"><p>Queue is empty</p><p class="text-sm">Add some tracks to get started!</p></div>';
    }

    let html = '<div class="queue-list queue-list-offline">';
    status.queue.forEach((track, index) => {
        const title = escapeHtml(track.title ?? track.track_title ?? `Track ${index + 1}`);
        const author = escapeHtml(track.author ?? track.track_author ?? 'Unknown artist');
        const duration = formatTime(track.duration ?? track.track_duration ?? 0);

        html += `
            <div class="queue-item">
                <div class="queue-item-info">
                    <div class="queue-item-title">${title}</div>
                    <div class="queue-item-author">${author}</div>
                </div>
                <div class="queue-item-duration">${duration}</div>
            </div>
        `;
    });
    html += '</div><div class="queue-offline-hint">Connect the bot to a voice channel to manage this queue live.</div>';
    return html;
}

function setQueueFooter(message) {
    const footer = document.getElementById('queue-last-updated');
    if (footer) {
        footer.textContent = message;
    }
}

function updateQueueTimestamp() {
    const now = new Date();
    const formatted = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    setQueueFooter(`Last updated — ${formatted}`);
}

function startProgressUpdates() {
    if (progressUpdateInterval) {
        clearInterval(progressUpdateInterval);
    }

    progressUpdateInterval = setInterval(() => {
        if (latestStatus && latestStatus.current_track && latestStatus.playing && !latestStatus.paused) {
            // Only update progress when actually playing (not paused)
            const currentTime = latestStatus.current_track.position + 1000; // Add 1 second
            latestStatus.current_track.position = currentTime;

            document.getElementById('current-time').textContent = formatTime(currentTime);

            const progress = latestStatus.current_track.duration
                ? Math.min(100, (currentTime / latestStatus.current_track.duration) * 100)
                : 0;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }
    }, 1000);
}

function stopProgressUpdates() {
    if (progressUpdateInterval) {
        clearInterval(progressUpdateInterval);
        progressUpdateInterval = null;
    }
}

function resetMusicView() {
    latestStatus = null;
    const connectionStatus = document.getElementById('connection-status');
    connectionStatus.className = 'status-indicator status-disconnected';
    connectionStatus.innerHTML = '<i class="fas fa-circle" style="color: #dc2626;"></i> Disconnected';

    const connectionDetails = document.getElementById('connection-details');
    connectionDetails.textContent = 'Connect the bot to a voice channel to enable playback controls.';

    document.getElementById('current-track').style.display = 'none';
    document.getElementById('progress-fill').style.width = '0%';

    ['play-pause-btn', 'skip-btn', 'stop-btn'].forEach((id) => {
        const button = document.getElementById(id);
        if (button) {
            button.disabled = true;
            if (id === 'play-pause-btn') {
                button.classList.remove('primary-active');
                button.innerHTML = '<i class="fas fa-play"></i>';
            }
        }
    });

    document.getElementById('volume-slider').disabled = true;
    document.getElementById('volume-display').textContent = '50%';
    document.getElementById('volume-slider').value = 50;

    document.getElementById('add-track-input').disabled = true;
    document.getElementById('add-track-button').disabled = true;

    document.getElementById('queue-count').textContent = '0';
    document.getElementById('queue-duration').textContent = '0:00';
    document.getElementById('queue-repeat').textContent = 'Off';
    document.getElementById('queue-shuffle').textContent = 'Off';
    setQueueFooter('Last updated — waiting…');
}

function handleMusicGuildChange(guildId) {
    currentGuildId = guildId;

    // Clear reconnect timeout if any
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
        reconnectTimeout = null;
    }

    // Close existing WebSocket connection
    if (musicWebSocket) {
        musicWebSocket.close();
        musicWebSocket = null;
    }

    // Stop progress updates
    stopProgressUpdates();

    const queueContainer = document.getElementById('queue-container');

    if (currentGuildId) {
        document.getElementById('guild-id-input').value = currentGuildId;
        document.getElementById('guild-id-hidden').value = currentGuildId;
        document.querySelectorAll('input[name="guild_id"]').forEach((input) => {
            input.value = currentGuildId;
        });

        if (queueContainer) {
            queueContainer.innerHTML = QUEUE_LOADING_HTML;
        }

        document.getElementById('add-track-input').disabled = true;
        document.getElementById('add-track-button').disabled = true;
        setQueueFooter('Last updated — connecting…');

        // Connect to WebSocket for real-time updates
        connectWebSocket(currentGuildId);

        // Start progress updates for current track
        startProgressUpdates();
    } else {
        document.getElementById('guild-id-input').value = '';
        document.getElementById('guild-id-hidden').value = '';
        document.querySelectorAll('input[name="guild_id"]').forEach((input) => {
            input.value = '';
        });

        if (queueContainer) {
            queueContainer.innerHTML = QUEUE_SELECT_SERVER_HTML;
        }

        resetMusicView();
    }
}

// Mode button event handlers (no longer needed since WebSocket handles updates automatically)

window.addEventListener('beforeunload', () => {
    stopProgressUpdates();
    if (musicWebSocket) {
        musicWebSocket.close();
    }
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
    }
});

// HTMX requests will trigger WebSocket broadcasts automatically from the server
</script>
{% endblock %}
