# Bot Core Framework Reference

- **Discord Clients** (`self.bot.gateway`, `self.bot.command_client`, `self.bot.miru_client`)
  - `gateway` is the Hikari `GatewayBot`; use its `.rest`, `.cache`, and voice helpers via the convenience properties surfaced on `DiscordBot`.【F:bot/core/bot.py†L22-L134】
  - `command_client` is the Lightbulb client used for slash command registration; the legacy `bot` attribute now emits a deprecation warning.【F:bot/core/bot.py†L102-L129】【F:bot/plugins/commands/registry.py†L140-L165】
  - `miru_client` is initialised in the bot constructor for component views; start/stop views through the Miru API before sending messages.【F:bot/core/bot.py†L30-L48】
- **Database Manager** (`self.db`/`self.bot.db`)
  - Use `async with self.db.session()` or the `BasePlugin.db_session()` helper to interact with the ORM; commits/rollbacks are managed automatically and shared across plugins.【F:bot/core/bot.py†L36-L133】【F:bot/plugins/base.py†L140-L179】
  - Register plugin models through mixins before startup so `DiscordBot._initialize_systems()` can create tables.【F:bot/core/bot.py†L92-L150】【F:bot/database/manager.py†L42-L123】
- **Event System** (`self.events`/`self.bot.event_system`)
  - Publish with `await self.emit_event("event_name", payload)` or access the event bus directly; decorated listeners are auto-managed during plugin load/unload.【F:bot/plugins/base.py†L58-L119】【F:bot/core/event_system.py†L9-L99】
  - Middleware can be added through `add_middleware()` for cross-cutting logging, metrics, or short-circuiting events.【F:bot/core/event_system.py†L11-L58】
- **Permission Manager** (`self.permissions`)
  - Check and modify role grants with helpers like `has_permission()`, `get_role_permissions()`, and `grant_permission()`; the manager is initialised during bot startup and seeded from plugin metadata.【F:bot/plugins/base.py†L38-L71】【F:bot/permissions/manager.py†L1-L200】
- **Prefix Message Handler** (`self.bot.message_handler`)
  - Registers prefix commands generated by `CommandRegistry` and enforces permission nodes before delegating to plugin callbacks.【F:bot/core/bot.py†L34-L89】【F:bot/core/message_handler.py†L1-L120】
- **Plugin Loader** (`self.bot.plugin_loader`)
  - Discovers plugin packages, instantiates subclasses of `BasePlugin`, wires dependencies, and stores metadata. Use it to introspect loaded plugins or reload modules in admin workflows.【F:bot/core/bot.py†L34-L89】【F:bot/core/plugin_loader.py†L1-L200】
- **Web Panel Manager** (`self.web_panel`)
  - Provides the FastAPI web app, auth guard, and static/template registration. `BasePlugin` automatically registers `WebPanelMixin` implementations on load/unload and exposes the cached manager for route helpers.【F:bot/core/bot.py†L58-L133】【F:bot/plugins/base.py†L60-L109】
- **Service Registry** (`self.bot.services`)
  - Core services (`gateway`, `command_client`, `db`, `events`, `permissions`, etc.) are registered under descriptive keys so plugins can request dependencies dynamically via `bot.get_service("name")`.【F:bot/core/bot.py†L52-L120】

## BasePlugin APIs
- **Lifecycle Hooks**
  - `on_load()` and `on_unload()` call into the `CommandRegistry`, register decorated event listeners, and wire optional web panels so plugins only need to populate command factories.【F:bot/plugins/base.py†L20-L77】
- **Cached Services**
  - `BasePlugin` exposes shortcuts (`self.db`, `self.events`, `self.permissions`, `self.web_panel`, `self.command_client`, `self.cache`, `self.rest`) so command code avoids repetitive `self.bot.*` lookups.【F:bot/plugins/base.py†L33-L80】
- **Command Registration**
  - Decorate callables with `bot.plugins.commands.decorators.command`; `BasePlugin`'s registry turns them into Lightbulb slash commands and prefix commands via `CommandRegistry`. Permissions defined through `permission_node` are enforced automatically.【F:bot/plugins/commands/decorators.py†L1-L130】【F:bot/plugins/commands/registry.py†L1-L210】
- **Database Helpers**
  - `db_session()` yields an async SQLAlchemy session; `with_session()` runs callbacks against the managed context while `get_setting()` / `set_setting()` continue to wrap plugin configuration storage.【F:bot/plugins/base.py†L140-L210】
  - `log_command_usage()` records executions in `CommandUsage`, ensuring guild/user rows exist before persisting analytics.【F:bot/plugins/base.py†L199-L274】
- **Response Utilities**
  - `respond_success()` / `respond_error()` create standard embeds, call `smart_respond()` under the hood, and optionally log outcomes; `track_command()` is available when manual try/except flows are required. Lower-level helpers like `smart_respond()` and `create_embed()` remain available for bespoke messaging.【F:bot/plugins/base.py†L180-L258】
- **Settings & Enablement**
  - `is_enabled_in_guild()`, `enable_in_guild()`, and `disable_in_guild()` wrap the settings helpers for feature toggles without extra boilerplate.【F:bot/plugins/base.py†L112-L141】
- **Logging**
  - Each plugin receives a namespaced logger (`plugin.<slug>`) and can reuse `log_command_usage()` plus standard logging practices for analytics.【F:bot/plugins/base.py†L13-L23】【F:bot/plugins/base.py†L128-L198】

## Common Patterns
- **Database Sessions**: Use `async with self.db_session()` (or `with_session`) to execute ORM statements, flush before commit when creating dependent records, and rely on manager-level rollback on exceptions.【F:bot/database/manager.py†L73-L123】【F:bot/plugins/base.py†L140-L210】
- **Event Publishing**: Emit events for cross-plugin communication and include defensive middleware for tracing or cancellation. Register listeners with `@event_listener` on coroutine methods within the plugin class so they are auto-managed.【F:bot/core/event_system.py†L9-L99】【F:bot/plugins/base.py†L34-L55】
- **Permission Workflows**: Query `PermissionManager` for role assignments (`get_role_permissions`, `get_all_permissions`) and adjust grants with `grant_permission` / `revoke_permission`. Pair command factories with `permission_node` metadata for consistent enforcement.【F:plugins/admin/commands/settings.py†L61-L141】
- **Embed & Respond Helpers**: Most commands now lean on `respond_success()` / `respond_error()` (wrapping `create_embed()` + `smart_respond()` + analytics). Drop to `smart_respond()` directly only when you need bespoke message layouts.【F:bot/plugins/base.py†L180-L258】【F:plugins/admin/commands/info.py†L24-L196】

## Extension Points
- **Event Middleware**: Register middleware coroutines on the event system to add logging, metrics, or cancellation logic around emitted events.【F:bot/core/event_system.py†L11-L99】
- **Plugin Metadata & Dependencies**: Declare `PLUGIN_METADATA` in plugin packages to expose descriptions, versions, permissions, and dependencies consumed by `PluginLoader`.【F:bot/core/plugin_loader.py†L34-L120】
- **Web Routes**: Mix in `WebPanelMixin` to register FastAPI routes, template directories, and static assets through `WebPanelManager` integration during plugin load/unload.【F:bot/plugins/base.py†L55-L77】
- **Database Models**: Use `DatabaseManager.register_plugin_model()` (typically via `DatabaseMixin`) so plugin-specific tables are created during startup and dropped cleanly on unload.【F:bot/database/manager.py†L42-L72】
- **Startup Tasks**: `DiscordBot.add_startup_task()` lets plugins schedule coroutines executed after all core systems initialise, enabling late binding without blocking gateway startup.【F:bot/core/bot.py†L70-L129】
