<!-- Shared JavaScript for sidebar functionality -->
<script>
    // Global guild selection handler
    function handleGlobalGuildChange(guildId) {
        const globalSelect = document.getElementById('global-guild-select');
        const guildIndicator = document.getElementById('global-guild-indicator');
        const guildNameSpan = document.getElementById('global-guild-name');

        if (guildId) {
            // Store selected guild in localStorage for persistence
            localStorage.setItem('selectedGuildId', guildId);

            // Get guild name from option data
            const selectedOption = globalSelect.options[globalSelect.selectedIndex];
            const guildName = selectedOption.getAttribute('data-name');

            // Show guild indicator in sidebar
            if (guildNameSpan && guildIndicator) {
                guildNameSpan.textContent = guildName;
                guildIndicator.style.display = 'flex';
            }

            // Emit custom events for plugins to listen to
            const guildChangeEvent = new CustomEvent('guild-changed', {
                detail: { guildId, guildName }
            });
            document.body.dispatchEvent(guildChangeEvent);

            console.log('Selected guild:', guildName, '(ID:', guildId, ')');
        } else {
            // Clear selection
            localStorage.removeItem('selectedGuildId');

            // Hide guild indicator
            if (guildIndicator) {
                guildIndicator.style.display = 'none';
            }

            const clearEvent = new CustomEvent('guild-changed', {
                detail: { guildId: null, guildName: null }
            });
            document.body.dispatchEvent(clearEvent);
        }
    }

    // Legacy function for backward compatibility
    function handleGuildChange(guildId) {
        return handleGlobalGuildChange(guildId);
    }

    // Logout function with token revocation
    async function logout() {
        try {
            // Call logout endpoint which will revoke tokens
            const response = await fetch('/auth/logout', {
                method: 'GET',
                credentials: 'same-origin',
                cache: 'no-cache'
            });

            console.log('Logout response status:', response.status);

            // Clear any local storage
            localStorage.clear();

            // Clear any session storage
            sessionStorage.clear();

            // Force reload to clear any cached authentication state
            window.location.replace('/');
        } catch (error) {
            console.error('Logout error:', error);
            // Clear storage and redirect even if endpoint fails
            localStorage.clear();
            sessionStorage.clear();
            window.location.replace('/');
        }
    }

    // Dark mode toggle
    function toggleDarkMode() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);

        // Update toggle button text
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
            toggleBtn.innerHTML = newTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        }
    }

    // Restore guild selection and theme on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Restore guild selection
        const savedGuildId = localStorage.getItem('selectedGuildId');
        const globalGuildSelect = document.getElementById('global-guild-select');

        if (savedGuildId && globalGuildSelect) {
            globalGuildSelect.value = savedGuildId;
            // Trigger change event to notify components
            handleGlobalGuildChange(savedGuildId);
        }

        // Restore theme preference
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Update toggle button if it exists
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
            toggleBtn.innerHTML = savedTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        }
    });
</script>